name: Swift CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.0'
        
      - name: Clean CocoaPods cache (optional)
        run: pod cache clean --all
        working-directory: ./checkcicd

      - name: Install CocoaPods
        run: pod install --repo-update
        working-directory: ./checkcicd
        
      - name: Create Derived Data directory if it doesn't exist
        run: mkdir -p ~/Library/Developer/Xcode/DerivedData


      - name: Set permissions on Derived Data
        run: sudo chmod -R 777 ~/Library/Developer/Xcode/DerivedData
        
      - name: Clean Derived Data (optional)
        run: sudo rm -rf ~/Library/Developer/Xcode/DerivedData/*
        
      - name: Clean project
        run: xcodebuild clean -scheme CheckCICD
        
      - name: Build project
        run: |
          xcodebuild -scheme CheckCICD \
          -sdk iphonesimulator \
          -destination "platform=iOS Simulator,name=iPhone 14,OS=16.0" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGN_IDENTITY="" \
          OTHER_LDFLAGS="-framework SnapKit" \
          FRAMEWORK_SEARCH_PATHS='$(inherited) $(PROJECT_DIR)/Pods/**' \
          LIBRARY_SEARCH_PATHS='$(inherited) $(PROJECT_DIR)/Pods/**' \
          build
